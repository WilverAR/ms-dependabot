name: Dependabot Auto-Fix (Manual)

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: read

jobs:
  autofix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Submit dependency snapshot (Gradle)
        uses: gradle/actions/dependency-submission@v5

      - name: Fetch Dependabot alerts
        id: alerts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.RENOVATE_TOKEN }}
          script: |
            const fs = require("fs");

            const alerts = await github.paginate(
              github.rest.dependabot.listAlertsForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "open",
                per_page: 100,
              }
            );

            const mapped = alerts.map((alert) => {
              const vuln = alert.security_vulnerability || {};
              const pkg = vuln.package || {};
              const patched = vuln.first_patched_version || {};
              const advisory = alert.security_advisory || {};
              return {
                alert_number: alert.number,
                ecosystem: pkg.ecosystem || null,
                name: pkg.name || null,
                fixed_version: patched.identifier || null,
                manifest_path: alert.dependency?.manifest_path || null,
                severity: advisory.severity || null,
              };
            });

            fs.writeFileSync("dependabot-alerts.json", JSON.stringify(mapped, null, 2));
            core.info(`Alerts written: ${mapped.length}`);
            for (const item of mapped) {
              core.info(
                `alert#${item.alert_number} ${item.name} fixed=${item.fixed_version} manifest=${item.manifest_path} severity=${item.severity}`
              );
            }
            core.setOutput("has_alerts", mapped.length > 0 ? "true" : "false");

      - name: Create security update PRs
        id: create_prs
        if: steps.alerts.outputs.has_alerts == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.RENOVATE_TOKEN }}
          script: |
            const fs = require("fs");
            const alerts = JSON.parse(fs.readFileSync("dependabot-alerts.json", "utf8"));
            const createdPrs = [];

            for (const alert of alerts) {
              try {
                const res = await github.request(
                  "POST /repos/{owner}/{repo}/dependabot/alerts/{alert_number}/security-updates",
                  {
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    alert_number: alert.alert_number,
                  }
                );
                const prUrl = res.data?.pull_request?.html_url || res.data?.pull_request?.url || null;
                if (prUrl) {
                  createdPrs.push(prUrl);
                  core.info(`Created security update PR for alert #${alert.alert_number}: ${prUrl}`);
                } else {
                  core.info(`Requested security update for alert #${alert.alert_number}`);
                }
              } catch (err) {
                core.warning(`Alert #${alert.alert_number}: ${err.status || "n/a"} ${err.message}`);
              }
            }

            // Fallback: gather recent Dependabot PRs if API response didn't include PR URLs.
            if (createdPrs.length === 0) {
              const since = new Date(Date.now() - 60 * 60 * 1000).toISOString();
              const prs = await github.paginate(
                github.rest.pulls.list,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: "open",
                  per_page: 100,
                  sort: "created",
                  direction: "desc",
                }
              );

              const filtered = prs.filter((pr) => {
                const isDependabot = pr.user?.login === "dependabot[bot]";
                const isRecent = pr.created_at >= since;
                return isDependabot && isRecent;
              });

              for (const pr of filtered) {
                createdPrs.push(pr.html_url);
                core.info(`Found recent Dependabot PR: ${pr.html_url}`);
              }
            }

            fs.writeFileSync("dependabot-prs.json", JSON.stringify(createdPrs, null, 2));
            core.setOutput("has_prs", createdPrs.length > 0 ? "true" : "false");

      - name: Upload alerts artifact
        if: steps.alerts.outputs.has_alerts == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dependabot-alerts
          path: dependabot-alerts.json

      - name: Upload PR list artifact
        if: steps.create_prs.outputs.has_prs == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dependabot-prs
          path: dependabot-prs.json

      - name: Cleanup alert file
        if: steps.alerts.outputs.has_alerts == 'true'
        run: |
          rm -f dependabot-alerts.json
        shell: bash

      - name: Aggregate dependabot PRs
        id: aggregate
        if: steps.create_prs.outputs.has_prs == 'true'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          BRANCH="auto-fix/aggregate-${{ github.run_id }}"
          git checkout -b "$BRANCH"

          PRS=$(node -e "const fs=require('fs'); const prs=JSON.parse(fs.readFileSync('dependabot-prs.json','utf8')); console.log(prs.map(p=>p.split('/').pop()).join(' '));")
          if [ -z "$PRS" ]; then
            echo "No PRs to aggregate."
            echo "aggregated=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          for pr in $PRS; do
            git fetch origin "pull/$pr/head:pr-$pr"
            git merge --no-ff --no-edit "pr-$pr"
          done

          echo "aggregated=true" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Create aggregated PR
        if: steps.aggregate.outputs.aggregated == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: auto-fix/aggregate-${{ github.run_id }}
          base: master
          title: "fix: aggregate dependabot alerts"
          body: |
            Automated security fixes aggregated from Dependabot security update PRs.
          commit-message: "fix: aggregate dependabot alerts"
