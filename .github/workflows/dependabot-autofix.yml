name: Dependabot Auto-Fix (Manual)

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: read

jobs:
  autofix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Submit dependency snapshot (Gradle)
        uses: gradle/actions/dependency-submission@v5

      - name: Fetch Dependabot alerts
        id: alerts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.RENOVATE_TOKEN }}
          script: |
            const fs = require("fs");

            const alerts = await github.paginate(
              github.rest.dependabot.listAlertsForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "open",
                per_page: 100,
              }
            );

            const mapped = alerts.map((alert) => {
              const vuln = alert.security_vulnerability || {};
              const pkg = vuln.package || {};
              const patched = vuln.first_patched_version || {};
              return {
                alert_number: alert.number,
                ecosystem: pkg.ecosystem || null,
                name: pkg.name || null,
                fixed_version: patched.identifier || null,
                manifest_path: alert.dependency?.manifest_path || null,
              };
            });

            fs.writeFileSync("dependabot-alerts.json", JSON.stringify(mapped, null, 2));
            core.info(`Alerts written: ${mapped.length}`);
            core.setOutput("has_alerts", mapped.length > 0 ? "true" : "false");

      - name: Apply fixes in build.gradle
        id: apply
        if: steps.alerts.outputs.has_alerts == 'true'
        run: |
          node scripts/dependabot-aggregate-fix.js
        shell: bash

      - name: Cleanup alert file
        if: steps.alerts.outputs.has_alerts == 'true'
        run: |
          rm -f dependabot-alerts.json
        shell: bash

      - name: Create aggregated PR
        if: steps.apply.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: auto-fix/dependabot-${{ github.run_id }}
          title: "fix: aggregate dependabot alerts"
          body: |
            Automated security fixes aggregated from Dependabot alerts.
          commit-message: "fix: aggregate dependabot alerts"
